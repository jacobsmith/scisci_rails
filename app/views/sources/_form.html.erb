<% url = (action_name == "new" ? {:action=>"create", :controller=>"sources"} : {:action=>"update", :controller=>"sources"})%>

<%= form_for([ @source ], url: url, html: { :'data-sourcetype' => @source.source_type }) do |f| %>
<% if @source.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@source.errors.count, "error") %> prohibited this source from being saved:</h2>

      <ul>
      <% @source.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <h3><small>Please select the type of resource below to continue. It helps us generate a custom MLA citation for you!</small></h3>
  <br>

  <ul class="source-edit-sourcetype">
    <li class="secondary button" data-sourcetype="book">
      Book or Encyclopedia
    </li>

    <li class="secondary button" data-sourcetype="magazine">
      Journal or Magazine
    </li>

    <li class="secondary button" data-sourcetype="web">
      Web Site
    </li>
  </ul>

  <br>
  
  <div class="googlebooks" data-fieldset="book" data-googlebooks>
    <h3>We'll help you find it!</h3>
    <p>Type in the name of the book below and we'll help you fill in the information below.</p>

    <div>
      <input type="text" placeholder="Example: A Tale of Two Cities" data-googlebooks-searchfield>
      <a class="small button" data-googlebooks-lookup>Find book</a>
      <a class="small secondary button" data-googlebooks-close>No thanks</a>
    </div>

    <p class="googlebooks-status" data-googlebooks-status>Loading...</p>
    <ul class="googlebooks-results" data-googlebooks-results>
    </ul>
  </div>

  <!-- following are SourceHelper methods -->
  <fieldset class="source-edit-fieldset" data-fieldset="book">
    <legend>Book Information</legend>
    <% book_information.each do |entry| %>
      <div class="form-field">
        <%= f.label entry.to_sym %>
        <%= f.text_field entry.to_sym %>
      </div>
    <% end %>
  </fieldset>

  <fieldset class="source-edit-fieldset" data-fieldset="magazine">
    <legend>Periodical Information</legend>
    <% magazine_information.each do |entry| %>
      <div class="form-field">
        <%= f.label entry.to_sym %>
        <%= f.text_field entry.to_sym %>
      </div>
    <% end %>
  </fieldset>
  
  <fieldset class="source-edit-fieldset" data-fieldset="web">
    <legend>Web Site Information</legend>
    <% web_information.each do |entry| %>
      <div class="form-field">
        <%= f.label entry.to_sym %>
        <%= f.text_field entry.to_sym %>
      </div>
    <% end %>
  </fieldset>


  <fieldset class="hide authors_div">
    <legend>Authors</legend>
    <a href="#" class="addAuthor hide" onclick="addAuthor(); return false;">Add Another Author</a>
  </fieldset>

  <fieldset class="hide comments">
    <legend>Comments</legend>
    <%= f.text_area :comments %>
    <label style="font-style: italic;">Optional: write a little about this source.</label>
  </fieldset>

  <%= f.hidden_field :source_type, value: "book" %>
  <%= f.hidden_field :image_url, value: "" %>

  <div class="actions hide submit">
    <% button_text = @source.new_record? ? "Create Source" : "Update Source" %>
    <%= f.submit button_text, class: "button radius" %>
  </div>
<% end %>

<% if !@source.new_record? %>

  <% authors = @source.authors.split(","); %>

  <script type="text/javascript">
    window.onload = function() {
      <% authors.each do |author| %>
        <% authorFirst = author.split[0] %>
        <% authorLast = author.split[1] %>
        addAuthor('<%= authorFirst %>', '<%= authorLast %>');
      <% end %>
    };
  </script>

<% end %>


<script type = "text/javascript">
      function updateAuthors(id, value) {
        document.getElementById(id).value += value;
      }
    </script>

    <script type="text/javascript">

      function addAuthor(authorFirstName, authorLastName) {
        authorFirstName = authorFirstName || "";
        authorLastName = authorLastName || "";

        var author_count = $(".authors_row").length;
        author_count++;

        var author_div = $(".authors_div");
        var authorFirst = "authorFirst#" + author_count;
        var authorLast = "authorLast#" + author_count;
        author_div.append('\
            <div class="row authors_row">\
            <div class="small-6 large-4 columns">\
            <div class="small-4 columns">\
            <label class="right inline" for="' + authorFirst + '">First</label>\
            </div>\
            \
            <div class="small-8 columns">\
            <input class="authors" id="' + authorFirst + '" name="source[' + authorFirst + ']" type="text">\
            </div>\
            </div>\
            \
            <div class="small-6 large-4 columns left">\
            <div class="small-4 columns">\
            <label class="right inline" for="' + authorLast + '">Last</label>\
            </div>\
            \
            <div class="small-8 columns">\
            <input class="authors" id="' + authorLast + '" name="source[' + authorLast + ']" type="text">\
            </div>\
            </div>\
            </div>');
      updateAuthors(authorFirst, authorFirstName);
      updateAuthors(authorLast, authorLastName);
      }

</script>

